import pandas as pd
import string

INPUT_FILENAME = 'reservations.xlsx'
STATIONS = ["ì„œìš¸", "ê´‘ëª…", "ì²œì•ˆì•„ì‚°", "ì˜¤ì†¡", "ëŒ€ì „", "ê¹€ì²œêµ¬ë¯¸", "ë™ëŒ€êµ¬", "ë¶€ì‚°"]
NUM_CARS = 8
SEATS_PER_CAR_ROWS = 15
SEATS_PER_CAR_COLS = "ABCD"


def load_seat_data():
    """CSV íŒŒì¼ì„ ì½ì–´ ì¢Œì„ë³„ ì˜ˆë§¤ ì •ë³´ë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ê°€ê³µí•©ë‹ˆë‹¤."""
    try:
        df = pd.read_excel(INPUT_FILENAME)
    except FileNotFoundError:
        print(f"ì—ëŸ¬: '{INPUT_FILENAME}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None

    seat_reservations = {}
    for record in df.to_dict('records'):
        seat_key = f"{record['car_no']}-{record['seat_no']}"
        if seat_key not in seat_reservations:
            seat_reservations[seat_key] = []
        seat_reservations[seat_key].append({
            "departure": record['departure_station'],
            "arrival": record['arrival_station']
        })
    return seat_reservations

def check_seat_reservation(all_seat_data, current_station, next_station, car_no, seat_no, stations_map):
    """íŠ¹ì • êµ¬ê°„ì—ì„œ ì¢Œì„ì´ ì˜ˆë§¤ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."""
    seat_key = f"{car_no}-{seat_no}"
    current_idx = stations_map.get(current_station, -1)
    next_idx = stations_map.get(next_station, -1)

    if seat_key in all_seat_data:
        for booking in all_seat_data[seat_key]:
            departure_idx = stations_map.get(booking['departure'], -1)
            arrival_idx = stations_map.get(booking['arrival'], -1)
            if departure_idx <= current_idx and next_idx <= arrival_idx:
                return True # ì˜ˆë§¤ë¨
    return False # ì˜ˆë§¤ë˜ì§€ ì•ŠìŒ (ë¹ˆ ì¢Œì„)


def simulate_api_request(seat_data, stations_map):
    """
    [ê¸°ëŠ¥ 1] API ìš”ì²­ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ íŠ¹ì • ì¢Œì„ì˜ ì˜ˆë§¤ ìƒíƒœë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
    """
    print("\n" + "#"*50)
    print("### ê¸°ëŠ¥ 1: ì‹¤ì‹œê°„ ì¢Œì„ í™•ì¸ (API ì‹œë®¬ë ˆì´ì…˜)")
    print("#"*50)
    
    current = "ëŒ€ì „"
    next_st = "ê¹€ì²œêµ¬ë¯¸"
    car = 5
    seat = "7A"

    is_reserved = check_seat_reservation(seat_data, current, next_st, car, seat, stations_map)

    if is_reserved:
        print(f"âœ”ï¸ ê²°ê³¼: {car}í˜¸ì°¨ {seat} ì¢Œì„ì€ í˜„ì¬ êµ¬ê°„({current} -> {next_st})ì— ì˜ˆë§¤ëœ ìŠ¹ê°ì´ ìˆìŠµë‹ˆë‹¤.")
    else:
        print(f"ğŸš¨ ê²°ê³¼: {car}í˜¸ì°¨ {seat} ì¢Œì„ì€ í˜„ì¬ êµ¬ê°„({current} -> {next_st})ì— ì˜ˆë§¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤! (ë¬´ì„ìŠ¹ì°¨ ì˜ì‹¬)")

def find_all_empty_seats(seat_data, stations_map):
    """
    [ê¸°ëŠ¥ 2] ê° ìš´í–‰ êµ¬ê°„ë³„ë¡œ ë¹„ì–´ìˆëŠ” ëª¨ë“  ì¢Œì„ì„ ê²€ìƒ‰í•˜ì—¬ ì¶œë ¥í•©ë‹ˆë‹¤.
    """
    print("\n" + "#"*50)
    print("### ê¸°ëŠ¥ 2: ì „ì²´ êµ¬ê°„ë³„ ë¹ˆ ì¢Œì„ ê²€ìƒ‰")
    print("#"*50)

    all_possible_seats = []
    for car in range(1, NUM_CARS + 1):
        for row in range(1, SEATS_PER_CAR_ROWS + 1):
            for col in SEATS_PER_CAR_COLS:
                all_possible_seats.append((car, f"{row}{col}"))

    for i in range(len(STATIONS) - 1):
        current_station = STATIONS[i]
        next_station = STATIONS[i+1]
        
        empty_seats_in_segment = []
        for car_no, seat_no in all_possible_seats:
            if not check_seat_reservation(seat_data, current_station, next_station, car_no, seat_no, stations_map):
                empty_seats_in_segment.append(f"{car_no}-{seat_no}")
        
        print("\n" + "="*50)
        print(f"ğŸ›¤ï¸  êµ¬ê°„: {current_station} -> {next_station}")
        print(f"âœ… ë¹ˆ ì¢Œì„ ìˆ˜: {len(empty_seats_in_segment)} ì„")
        if len(empty_seats_in_segment) > 10:
             print(f"ğŸª‘ ë¹ˆ ì¢Œì„ ëª©ë¡ (ì¼ë¶€): {', '.join(empty_seats_in_segment[:10])} ë“±")
        else:
             print(f"ğŸª‘ ë¹ˆ ì¢Œì„ ëª©ë¡: {', '.join(empty_seats_in_segment)}")
        print("="*50)

# --- ë©”ì¸ ì‹¤í–‰ ë¶€ë¶„ ---

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    # 1. (ê³µí†µ) ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œ
    seat_data = load_seat_data()
    if not seat_data:
        return

    # 2. (ê³µí†µ) stations_mapì„ í•œ ë²ˆë§Œ ìƒì„±í•˜ì—¬ ì¬ì‚¬ìš©
    stations_map = {station: i for i, station in enumerate(STATIONS)}
    print("âœ… ë°ì´í„° ë¡œë“œ ë° 'stations_map' ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")

    # 3. ê° ê¸°ëŠ¥ í•¨ìˆ˜ë¥¼ ìˆœì„œëŒ€ë¡œ í˜¸ì¶œ
    simulate_api_request(seat_data, stations_map)
    find_all_empty_seats(seat_data, stations_map)


if __name__ == "__main__":
    main()
